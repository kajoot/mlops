stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

# Test stage - Lint and validate code
code-quality:
  stage: test
  image: python:3.12-slim
  script:
    - pip install flake8 black
    - echo "Running code quality checks..."
    - flake8 src/ api/ pipelines/ --max-line-length=120 --ignore=E501,W503 || true
    - black --check src/ api/ pipelines/ || true
  only:
    - main
    - dev
    - merge_requests

# Test stage - Run unit tests
unit-tests:
  stage: test
  image: python:3.12-slim
  script:
    - pip install -r requirements.txt
    - echo "Running unit tests..."
    - python -m pytest tests/ -v || echo "No tests found - implement later"
  only:
    - main
    - dev
    - merge_requests

# Build stage - Build Docker images
build-train-image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building training image..."
    - docker build -t $CI_REGISTRY_IMAGE/train:$CI_COMMIT_SHORT_SHA -f Dockerfile.train .
    - docker build -t $CI_REGISTRY_IMAGE/train:latest -f Dockerfile.train .
    - docker push $CI_REGISTRY_IMAGE/train:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/train:latest
  only:
    - main
    - tags

build-api-image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building API image..."
    - docker build -t $CI_REGISTRY_IMAGE/api:$CI_COMMIT_SHORT_SHA -f Dockerfile.api .
    - docker build -t $CI_REGISTRY_IMAGE/api:latest -f Dockerfile.api .
    - docker push $CI_REGISTRY_IMAGE/api:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/api:latest
  only:
    - main
    - tags

# Continuous Training (CT) - Scheduled job
smoke-training:
  stage: build
  image: python:3.12-slim
  script:
    - pip install -r requirements.txt
    - echo "Running smoke training with subset..."
    - python src/data_loader.py
    - python src/train.py
  only:
    - schedules
    - main
  allow_failure: true

# Deploy stage - Deploy to production
deploy-api:
  stage: deploy
  image: docker:latest
  script:
    - echo "Deploying API to production..."
    - echo "In production, this would deploy to your infrastructure"
    - echo "Using docker-compose or Kubernetes"
  only:
    - tags
  when: manual
  environment:
    name: production
    url: http://api.example.com
